<!doctype html5>
<html>

<!--

This example case should verify (generated by JwsTest.java):

eyJhbGciOiJSUzI1NiIsImp3ayI6eyJrdHkiOiJSU0EiLCJuIjoibUNVZkpzSGF3Wll5SkVhS3FySHNKVlBmMjgxeE8xbHU1RThLTlo3SGVDLVVNWVdyeUlPclVWMGdEU0czRDExODNycXU0UEdnSWlyalF5OWhGenZxbUFnazN6NWNVS2xjMnFQQVB6UzU2R1FlbFhETkt6OWJJOC03Vy1sOVRTWnBDdzBRVWpaU2twZWFIdElrVXpZT2R6OEpXS2cxM0h2OGdSTWo3WHpxQ0lfOHowbGpaSk5yV0NSY2U0TEExUzRKMm9uZXhOcUo3OTVXUERBXzR3Nk1GOUI0b3BxMk16S3o4RmI1aVlGLUxpb29jLW1IeUtHVjJYTFNYcXNYa05sSE5LeDI0REQ1TXFOWjJRc3h2by1GUXZwd0h0TzNIUEpPdER1Z3F2M0ItU0tqc3B6VFNCNC15MC16Z1o0ZnJMSmJGWUJpNXRSRzk1eDRKVHlJektZM2p3IiwiZSI6IkFRQUIifX0.VGhpcyBpcyBzb21lIHRleHQgdGhhdCBpcyB0byBiZSBzaWduZWQu.MeQFUWWQdFxbfitTGOBLePqWC7NtOl5PY6ohq8oXGGl_2Z9OkXFPGYjpCrf8Tvlw0PKMdEQV11_DboPTC9WrV7BX6u2RhV-0TLz1zTCrfwaXyQPcuCCpKeabZm5CjMt-BteNVynt2Wl_88wRGW4pwv8iarWp5e8boUFcgkMCmlyq6UPsT6gg4LACRddcNMZZCpQT_xiKgLu9XqoZDVohZHiY-4wrNtNpmsrQAgiqg8af1wEAos8S7QPv4cIQfM0DXDnEQbpRYRb0jTQU1VBx6-QkDAHLLfrRWWQwGOXJ7bM3s8dodMZ9r-oJq029yeHAQMn_CbB0hTWS29ymTyMxiA

{
  "protected": "eyJhbGciOiJSUzI1NiIsImp3ayI6eyJrdHkiOiJSU0EiLCJuIjoibUNVZkpzSGF3Wll5SkVhS3FySHNKVlBmMjgxeE8xbHU1RThLTlo3SGVDLVVNWVdyeUlPclVWMGdEU0czRDExODNycXU0UEdnSWlyalF5OWhGenZxbUFnazN6NWNVS2xjMnFQQVB6UzU2R1FlbFhETkt6OWJJOC03Vy1sOVRTWnBDdzBRVWpaU2twZWFIdElrVXpZT2R6OEpXS2cxM0h2OGdSTWo3WHpxQ0lfOHowbGpaSk5yV0NSY2U0TEExUzRKMm9uZXhOcUo3OTVXUERBXzR3Nk1GOUI0b3BxMk16S3o4RmI1aVlGLUxpb29jLW1IeUtHVjJYTFNYcXNYa05sSE5LeDI0REQ1TXFOWjJRc3h2by1GUXZwd0h0TzNIUEpPdER1Z3F2M0ItU0tqc3B6VFNCNC15MC16Z1o0ZnJMSmJGWUJpNXRSRzk1eDRKVHlJektZM2p3IiwiZSI6IkFRQUIifX0",
  "payload": "VGhpcyBpcyBzb21lIHRleHQgdGhhdCBpcyB0byBiZSBzaWduZWQu",
  "signature": "MeQFUWWQdFxbfitTGOBLePqWC7NtOl5PY6ohq8oXGGl_2Z9OkXFPGYjpCrf8Tvlw0PKMdEQV11_DboPTC9WrV7BX6u2RhV-0TLz1zTCrfwaXyQPcuCCpKeabZm5CjMt-BteNVynt2Wl_88wRGW4pwv8iarWp5e8boUFcgkMCmlyq6UPsT6gg4LACRddcNMZZCpQT_xiKgLu9XqoZDVohZHiY-4wrNtNpmsrQAgiqg8af1wEAos8S7QPv4cIQfM0DXDnEQbpRYRb0jTQU1VBx6-QkDAHLLfrRWWQwGOXJ7bM3s8dodMZ9r-oJq029yeHAQMn_CbB0hTWS29ymTyMxiA"
}

This case should also verify:

{
  "header": {
    "alg": "RS256",
    "jwk": {
      "e": "AQAB",
      "kty": "RSA",
      "n": "tSwgy3ORGvc7YJI9B2qqkelZRUC6F1S5NwXFvM4w5-M0TsxbFsH5UH6adigV0jzsDJ5imAechcSoOhAh9POceCbPN1sTNwLpNbOLiQQ7RD5mY_pSUHWXNmS9R4NZ3t2fQAzPeW7jOfF0LKuJRGkekx6tXP1uSnNibgpJULNc4208dgBaCHo3mvaE2HV2GmVl1yxwWX5QZZkGQGjNDZYnjFfa2DKVvFs0QbAk21ROm594kAxlRlMMrvqlf24Eq4ERO0ptzpZgm_3j_e4hGRD39gJS7kAzK-j2cacFQ5Qi2Y6wZI2p-FCq_wiYsfEAIkATPBiLKl_6d_Jfcvs_impcXQ"
    }
  },
  "payload": "Zm9vCg",
  "signature": "hRt2eYqBd_MyMRNIh8PEIACoFtmBi7BHTLBaAhpSU6zyDAFdEBaX7us4VB9Vo1afOL03Q8iuoRA0AT4akdV_mQTAQ_jhTcVOAeXPr0tB8b8Q11UPQ0tXJYmU4spAW2SapJIvO50ntUaqU05kZd0qw8-noH1Lja-aNnU-tQII4iYVvlTiRJ5g8_CADsvJqOk6FcHuo2mG643TRnhkAxUtazvHyIHeXMxydMMSrpwUwzMtln4ZJYBNx4QGEq6OhpAD_VSp-w8Lq5HOwGQoNs0bPxH1SGrArt67LFQBfjlVr94E1sn26p4vigXm83nJdNhWAMHHE9iV67xN-r29LT-FjA"
}

-->

<head>
<title>JWS verifier</title>
<script>

function toNormalB64(b64) {
  var out = b64.replace(/-/g, "+").replace(/_/g, "/");
  while (out.length % 4 != 0) { out += "="; }
  return out;
}

function toUint8Array(x) {
  return new Uint8Array([x.charCodeAt(i) for (i in x)]);
}


function webCryptoAlg(alg) {
  switch (alg) {
    case "RS256": return { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" };
    case "RS384": return { name: "RSASSA-PKCS1-v1_5", hash: "SHA-384" }; // untested
    case "RS512": return { name: "RSASSA-PKCS1-v1_5", hash: "SHA-512" }; // untested
    case "ES256": return { name: "ECDSA", namedCurve: "P-256", hash: "SHA-256" }; // untested
    case "ES384": return { name: "ECDSA", namedCurve: "P-384", hash: "SHA-384" }; // untested
    case "ES512": return { name: "ECDSA", namedCurve: "P-512", hash: "SHA-512" }; // untested
  }
  return null;
}

function verify() {
  var jwsIn = document.getElementById("jwsIn").value;
  document.getElementById("resultOut").innerHTML = "(working)";

  var protected, header, payload, signature;
  if (jwsIn.match(/[\w_-]+\.[\w_-]+\.[\w_-]+/)) {
    var [protected, payload, signature] = jwsIn.split(/\./);
  } else {
    try {
      var jws = JSON.parse(jwsIn);
      protected = jws.protected;
      header = jws.header;
      payload = jws.payload;
      signature = jws.signature;
    } catch (e) {
      console.log(e);
      return;
    }
  }

  protected = protected || "";
  header = header || JSON.parse(atob(toNormalB64(protected)));
  var alg = webCryptoAlg(header.alg)
  var data = toUint8Array(protected + "." + payload);
  var sig = toUint8Array(atob(toNormalB64(signature)));

  crypto.subtle.importKey("jwk", header.jwk, alg, true, ["verify"])
    .then(k => crypto.subtle.verify(alg, k, sig, data) )
    .then(x => { document.getElementById("resultOut").innerHTML = (x)? "Valid" : "Invalid"; })
    .catch(x => { document.getElementById("resultOut").innerHTML = "Error: " + x; });
}

</script>
</head>

<body>
<textarea id="jwsIn" rows="20" cols="90"></textarea>
<br/>
<button onclick="verify();">verify</button>
<br/>
<span id="resultOut"></span>
</body>

</html>
